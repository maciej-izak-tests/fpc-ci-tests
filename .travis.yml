language: cpp
system: linux

install:
  - sudo apt-get update -qq
  - sudo apt-get install -y gcc-multilib
  - sudo apt-get install -y build-essential
  - sudo apt-get install -y qemu
  - sudo apt-get install -y unzip
  - sudo apt-get install -y dosbox

script:
# initialization for basic variables
  - cd ..
  - main_dir=`pwd`
  - fpc_base_dir=$main_dir'/fpc/lib/fpc/3.1.1'
  - PATH=$main_dir/binutils/bin:$main_dir/fpc/bin:$fpc_base_dir:$PATH
  - bootstrap=FPC=$main_dir/bootstrap/ppcx64-linux
  - installprefix=INSTALL_PREFIX=$main_dir/fpc
# download bootstrap compiler
  - mkdir bootstrap
  - cd bootstrap
  - wget https://github.com/maciej-izak/fpc-ci-tests/releases/download/bootstrap/ppcx64-linux
  - chmod +x ppcx64-linux
  - cd $main_dir
# download and build binutils for m68k
  - wget ftp://ftp.gnu.org/gnu/binutils/binutils-2.29.1.tar.bz2
  - tar xvjf binutils-2.29.1.tar.bz2
  - cd binutils-2.29.1
  - ./configure --target=m68k-elf --prefix=$main_dir/binutils
  - make  
  - make install
  - cd $main_dir
# download and build fpc
  - wget https://github.com/newpascal/freepascal/archive/freepascal.zip
  - unzip freepascal.zip
  - cd freepascal-freepascal
  - make all $bootstrap
  - make install $bootstrap $installprefix 
  - chmod -R 777 $main_dir/fpc/bin
  - sudo $fpc_base_dir/samplecfg $fpc_base_dir
  - cd $main_dir
#build dos
  - wget https://github.com/newpascal/fpcupdeluxe/releases/download/linuxx64crossbins_v1.0/CrossBinsMSDosi8086.zip
  - unzip CrossBinsMSDosi8086.zip -d binutils/bin
  - cd $main_dir/binutils/bin
  - mv nasm msdos-nasm 
  - cd $main_dir/freepascal-freepascal
  - make clean $bootstrap
  - make compiler_cycle CROSSINSTALL=1 CPU_TARGET=i8086 OS_TARGET=msdos FPC=ppcx64 "OPT=-CX -XXs" CROSSOPT="-WmMedium"
  - cp -f ./compiler/ppcross8086 $fpc_base_dir
  - make rtl packages CROSSINSTALL=1 "OPT=-CX -XXs" "OS_TARGET=msdos" "CPU_TARGET=i8086" CROSSOPT="-WmMedium" FPC=ppcross8086
  - make rtl_install packages_install CROSSINSTALL=1 CPU_TARGET=i8086 "OPT=-CX -XXs" CROSSOPT="-WmMedium" OS_TARGET=msdos FPC=ppcross8086 PREFIX=$main_dir/fpc
# test for dos 
  - fpc tests/utils/dosbox/dosbox_wrapper.pas
  - DOSBOX=/usr/bin/dosbox
  - cd tests
  - ulimit -m 256000
  - ulimit -d 256000
  - make full TEST_FPC=ppcross8086 TEST_OPT=-WmMedium EMULATOR=$main_dir/freepascal-freepascal/tests/utils/dosbox/dosbox_wrapper
# build m68k target
  - cd $main_dir/freepascal-freepascal
  - make clean $bootstrap
  - make compiler_cycle CROSSINSTALL=1 CPU_TARGET=m68k OS_TARGET=linux BINUTILSPREFIX=m68k-elf- FPC=ppcx64
  - cp -f ./compiler/ppcross68k $fpc_base_dir
  - make rtl packages CROSSINSTALL=1 CPU_TARGET=m68k OS_TARGET=linux CROSSOPT="-O- -Cpisac" BINUTILSPREFIX=m68k-elf- FPC=ppcross68k
  - make rtl_install packages_install CROSSINSTALL=1 CPU_TARGET=m68k CROSSOPT="-O- -Cpisac" OS_TARGET=linux BINUTILSPREFIX=m68k-elf- FPC=ppcross68k PREFIX=$main_dir/fpc
  - cd $main_dir
# test for m68k 
  - echo 'timeout -k 2s 60s qemu-m68k -cpu cfv4e $@' >> run-qemu-m68k
  - chmod +x run-qemu-m68k
  - cd freepascal-freepascal/tests/
  - make full TEST_FPC=$fpc_base_dir/ppcross68k TEST_OPT="-O- -Cpisac -XPm68k-elf-" EMULATOR=$main_dir/run-qemu-m68k CHUNKSIZE=50 -j 2